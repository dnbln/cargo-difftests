name: Test rust
on:
    push:
        branches:
            - trunk
    pull_request:
        branches:
            - trunk

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Install latest nightly
          uses: actions-rs/toolchain@v1
          with:
            toolchain: nightly
            override: true
            components: rustfmt, clippy
        
        - name: Move config file
          run: mv .cargo/config.toml .cargo/config2.toml

        - name: Install required cargo-difftests helper binaries
          run: cargo install --path cargo-difftests --bin rustc-wrapper-difftests --bin rustc-wrapper-difftests-workspace
        
        - name: Move config file back
          run: mv .cargo/config2.toml .cargo/config.toml

        - name: Build
          run: cargo build

        - name: Test
          run: cargo test
